### Trip Planning API - Authentication Tests
### Use with IntelliJ IDEA HTTP Client

@url = http://localhost:7070/api
@admin_username = admin
@admin_password = admin123
@user_username = user
@user_password = user123

#######################################################################
# PUBLIC ENDPOINTS - No authentication required
#######################################################################

### Health Check (if you add one)
GET {{url}}/health

> {% client.test("Health check OK", () => {
    client.assert(response.status === 200 || response.status === 404, "Expected 200 or 404");
}); %}

#######################################################################
# AUTHENTICATION FLOW
#######################################################################

### 1. Register New User (409 if already exists)
# @name RegisterNewUser
POST {{url}}/register
Content-Type: application/json

{
  "username": "testuser",
  "password": "testpass123"
}

> {% 
    client.test("Register user accepted", () => {
        client.assert([201, 400, 409].includes(response.status), 
            "Expected 201 (created), 400 (validation), or 409 (already exists)");
    });
%}

### 2. Login as ADMIN (capture token)
# @name LoginAdmin
POST {{url}}/login
Content-Type: application/json

{
  "username": "{{admin_username}}",
  "password": "{{admin_password}}"
}

> {%
    let data = response.body;
    if (typeof data === "string") { 
        try { data = JSON.parse(data); } catch(e) {} 
    }
    client.test("Admin login successful", () => {
        client.assert(response.status === 200, "Expected 200");
        client.assert(data && data.token, "Token should be present");
        client.assert(data && data.username === "admin", "Username should be admin");
    });
    if (data && data.token) {
        client.global.set("admin_token", data.token);
    }
%}

### 3. Login as USER (capture token)
# @name LoginUser
POST {{url}}/login
Content-Type: application/json

{
  "username": "{{user_username}}",
  "password": "{{user_password}}"
}

> {%
    let data = response.body;
    if (typeof data === "string") { 
        try { data = JSON.parse(data); } catch(e) {} 
    }
    client.test("User login successful", () => {
        client.assert(response.status === 200, "Expected 200");
        client.assert(data && data.token, "Token should be present");
    });
    if (data && data.token) {
        client.global.set("user_token", data.token);
    }
%}

### 4. Login with Wrong Password (should fail)
# @name LoginWrongPassword1
POST {{url}}/login
Content-Type: application/json

{
  "username": "{{admin_username}}",
  "password": "wrongpassword"
}

> {%
    client.test("Wrong password returns 401", () => {
        client.assert(response.status === 401, "Expected 401 Unauthorized");
    });
%}

### 5. Login with Non-Existent User
# @name LoginNonExistent
POST {{url}}/login
Content-Type: application/json

{
  "username": "nonexistentuser",
  "password": "anypassword"
}

> {%
    client.test("Non-existent user returns 401", () => {
        client.assert(response.status === 401, "Expected 401 Unauthorized");
    });
%}

#######################################################################
# SECURITY TESTS
#######################################################################

### 6. Access Protected Endpoint Without Token (should be 401)
# @name NoTokenTest
GET {{url}}/trips

> {%
    client.test("No token returns 401", () => {
        client.assert(response.status === 401, "Expected 401 Unauthorized");
    });
%}

### 7. Access Protected Endpoint With Invalid Token
# @name InvalidTokenTest
GET {{url}}/trips
Authorization: Bearer invalid.fake.token

> {%
    client.test("Invalid token returns 401", () => {
        client.assert(response.status === 401, "Expected 401 Unauthorized");
    });
%}

### 8. USER tries to delete (ADMIN only) - Should be 403
# @name UserDeleteForbidden
DELETE {{url}}/trips/999
Authorization: Bearer {{user_token}}

> {%
    client.test("USER cannot delete (403 Forbidden)", () => {
        client.assert(response.status === 403 || response.status === 404, 
            "Expected 403 Forbidden or 404 Not Found");
    });
%}

### 9. Verify Admin Token Works
# @name AdminTokenWorks
GET {{url}}/trips
Authorization: Bearer {{admin_token}}

> {%
    client.test("Admin token works", () => {
        client.assert(response.status === 200, "Expected 200");
    });
%}

### 10. Verify User Token Works
# @name UserTokenWorks
GET {{url}}/trips
Authorization: Bearer {{user_token}}

> {%
    client.test("User token works", () => {
        client.assert(response.status === 200, "Expected 200");
    });
%}

#######################################################################
# SUMMARY
#######################################################################

### Run all tests in sequence and check:
### ✅ Admin can login and get token
### ✅ User can login and get token
### ✅ Wrong credentials return 401
### ✅ No token returns 401
### ✅ Invalid token returns 401
### ✅ Role-based access control works (USER vs ADMIN)
